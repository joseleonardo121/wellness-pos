{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center fw-bold text-primary">üõí Realizar Venta</h2>

    <!-- Barra de b√∫squeda -->
    <div class="card shadow-sm p-4 mb-4 border-0 rounded-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-7">
                <input id="codigo_barras" type="text" class="form-control form-control-lg shadow-sm" placeholder="üîé Escanea o ingresa el c√≥digo o dise√±o del producto">
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary btn-lg w-100 shadow-sm fw-bold" onclick="buscarProducto()">Buscar Producto</button>
            </div>
        </div>
    </div>

    <!-- Preview del producto encontrado -->
    <div id="previewProducto" class="card shadow-sm p-4 mb-4 border-0 rounded-4 d-none">
        <h5 class="fw-bold text-secondary mb-3">üì¶ Producto encontrado</h5>

        <table class="table table-sm table-bordered mb-3 text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>C√≥digo</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Dise√±o</th>
                    <th>Talla</th>
                    <th>Color</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="pvCodigo"></td>
                    <td id="pvMarca"></td>
                    <td id="pvModelo"></td>
                    <td id="pvDiseno"></td>
                    <td id="pvTalla"></td>
                    <td id="pvColor"></td>
                </tr>
            </tbody>
        </table>

        <div class="alert alert-info py-2 mb-3">
            <b>üí≤ Precio:</b> <span id="pvPrecio"></span>
        </div>

        <h6 class="fw-bold text-secondary">üì¶ Stock por sucursal</h6>
        <table class="table table-sm table-bordered text-center align-middle mb-4">
            <thead class="table-light">
                <tr>
                    <th>Sucursal 1</th>
                    <th>Sucursal 2</th>
                    <th>Sucursal 3</th>
                    <th>Almac√©n</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="pvS1">-</td>
                    <td id="pvS2">-</td>
                    <td id="pvS3">-</td>
                    <td id="pvAlmacen">-</td>
                    <td id="pvStockTotal">-</td>
                </tr>
            </tbody>
        </table>

        <!-- Cantidad + Descuento + Bot√≥n agregar -->
        <div class="row g-3 align-items-end mt-2">
            <div class="col-md-3">
                <label for="pvCantidad" class="form-label fw-bold">Cantidad</label>
                <input type="number" id="pvCantidad" class="form-control text-center shadow-sm" min="1" value="1">
            </div>

            <div class="col-md-4">
                <label for="pvDescuento" class="form-label fw-bold text-danger">Descuento (S/.)</label>
                <input type="number" id="pvDescuento"
                       class="form-control text-center shadow-sm border-danger fw-bold"
                       style="background-color:#fff5f5; color:#c92a2a; font-size:1.1rem;"
                       min="0" step="0.01" value="0" placeholder="Ej: 5.00">
            </div>

            <div class="col-md-4">
                <button id="btnAgregarPreview"
                        class="btn btn-success btn-lg w-100 shadow-sm fw-bold rounded-3"
                        onclick="agregarProducto()" disabled>‚ûï Agregar Producto</button>
            </div>
        </div>
    </div>

    <!-- Tabla de venta -->
    <form method="post" id="ventaForm">
        {% csrf_token %}
        <div class="card shadow-sm p-4 mb-4 border-0 rounded-4">
            <h5 class="fw-bold text-secondary mb-3">üßæ Detalles de la venta</h5>
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="tablaVenta">
                    <thead class="table-primary">
                        <tr>
                            <th>C√≥digo</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Dise√±o</th>
                            <th>Talla</th>
                            <th>Color</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Descuento</th>
                            <th>Subtotal</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody class="align-middle"></tbody>
                </table>
            </div>
            <h4 class="text-end mt-3 fw-bold text-success">Total: S/ <span id="totalVenta">0.00</span></h4>
        </div>

        <!-- M√©todo de pago -->
        <div class="card shadow-sm p-4 mb-4 border-0 rounded-4">
            <h5 class="fw-bold text-secondary mb-3">üí≥ M√©todo de Pago</h5>
            <select name="metodo_pago" class="form-select form-select-lg shadow-sm" required>
                <option value="efectivo">Efectivo</option>
                <option value="yape">Yape</option>
                <option value="visa">Visa</option>
                <option value="mixto">Mixto</option>
            </select>
        </div>

        <!-- Sucursal -->
        <div class="card shadow-sm p-4 mb-4 border-0 rounded-4">
            <h5 class="fw-bold text-secondary mb-3">üè¨ Sucursal</h5>
            <select name="sucursal" class="form-select form-select-lg shadow-sm" required>
                <option value="S1">Sucursal 1</option>
                <option value="S2">Sucursal 2</option>
                <option value="S3">Sucursal 3</option>
                <option value="A">Almac√©n</option>
            </select>
        </div>

        <!-- Bot√≥n confirmar -->
        <div class="text-end mt-4">
            <button type="submit" class="btn btn-success btn-lg px-5 shadow-lg fw-bold rounded-4">‚úÖ Confirmar Venta</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let productoPreview = null;
let productosAgregados = [];

/* Buscar producto */
function buscarProducto() {
    const codigo = document.getElementById("codigo_barras").value.trim();
    if (!codigo) {
        Swal.fire({
            icon: 'warning',
            title: 'Campo vac√≠o',
            text: 'Ingrese o escanee un c√≥digo de producto.',
            confirmButtonColor: '#3085d6'
        });
        return;
    }

    fetch(`/inventory/api/producto/?codigo=${encodeURIComponent(codigo)}`)
        .then(async (res) => {
            const json = await res.json().catch(() => ({ error: "Respuesta inv√°lida" }));
            if (!res.ok) throw new Error(json.error || "Producto no encontrado");
            return json;
        })
        .then(data => {
            productoPreview = data;
            document.getElementById("pvCodigo").innerText = data.Codigo || "N/A";
            document.getElementById("pvMarca").innerText = data.Marca || "N/A";
            document.getElementById("pvModelo").innerText = data.Modelo || "N/A";
            document.getElementById("pvDiseno").innerText = data.Diseno || "N/A";
            document.getElementById("pvTalla").innerText = data.Talla || "N/A";
            document.getElementById("pvColor").innerText = data.Color || "N/A";
            document.getElementById("pvPrecio").innerText = Number(data.Precio).toFixed(2);
            document.getElementById("pvS1").innerText = data.S1 ?? 0;
            document.getElementById("pvS2").innerText = data.S2 ?? 0;
            document.getElementById("pvS3").innerText = data.S3 ?? 0;
            document.getElementById("pvAlmacen").innerText = data.Almacen ?? 0;
            document.getElementById("pvStockTotal").innerText = data.stock_total ?? 0;

            document.getElementById("previewProducto").classList.remove("d-none");
            document.getElementById("btnAgregarPreview").disabled = false;
        })
        .catch(err => {
            productoPreview = null;
            document.getElementById("previewProducto").classList.add("d-none");
            document.getElementById("btnAgregarPreview").disabled = true;
            Swal.fire({
                icon: 'error',
                title: 'Producto no encontrado',
                text: err.message || 'Verifique el c√≥digo e intente nuevamente',
                confirmButtonColor: '#d33'
            });
        });
}

/* Agregar producto */
function agregarProducto() {
    const cantidad = parseInt(document.getElementById("pvCantidad").value);
    const descuento = parseFloat(document.getElementById("pvDescuento").value) || 0;

    if (!productoPreview) return;
    if (cantidad > productoPreview.stock_total) {
        Swal.fire({
            icon: 'error',
            title: 'Stock insuficiente',
            text: 'No hay suficiente stock disponible.',
            confirmButtonColor: '#d33'
        });
        return;
    }

    const subtotal = (cantidad * productoPreview.Precio) - descuento;

    productosAgregados.push({
        Codigo: productoPreview.Codigo,
        Marca: productoPreview.Marca,
        Modelo: productoPreview.Modelo,
        Diseno: productoPreview.Diseno,
        Talla: productoPreview.Talla,
        Color: productoPreview.Color,
        cantidad: cantidad,
        precio_unitario: productoPreview.Precio,
        descuento: descuento,
        subtotal: subtotal
    });

    actualizarTabla();
    document.getElementById("codigo_barras").value = "";
    document.getElementById("previewProducto").classList.add("d-none");

    Swal.fire({
        icon: 'success',
        title: 'Producto agregado',
        showConfirmButton: false,
        timer: 900
    });
}

/* Actualizar tabla */
function actualizarTabla() {
    const tbody = document.querySelector("#tablaVenta tbody");
    tbody.innerHTML = "";
    let total = 0;

    productosAgregados.forEach((p, index) => {
        total += p.subtotal;
        const row = `<tr>
            <td>${p.Codigo}</td>
            <td>${p.Marca}</td>
            <td>${p.Modelo}</td>
            <td>${p.Diseno}</td>
            <td>${p.Talla}</td>
            <td>${p.Color}</td>
            <td>${p.cantidad}</td>
            <td>${p.precio_unitario.toFixed(2)}</td>
            <td>${p.descuento.toFixed(2)}</td>
            <td class="fw-bold text-success">${p.subtotal.toFixed(2)}</td>
            <td><button class="btn btn-outline-danger btn-sm fw-bold rounded-3" onclick="eliminarProducto(${index})">üóëÔ∏è Quitar</button></td>
        </tr>`;
        tbody.innerHTML += row;
    });

    document.getElementById("totalVenta").innerText = total.toFixed(2);
}

/* Eliminar producto */
function eliminarProducto(index) {
    productosAgregados.splice(index, 1);
    actualizarTabla();

    Swal.fire({
        icon: 'info',
        title: 'Producto eliminado',
        showConfirmButton: false,
        timer: 800
    });
}

/* Enviar venta */
document.getElementById("ventaForm").addEventListener("submit", function (e) {
    e.preventDefault();

    if (productosAgregados.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin productos',
            text: 'Agrega al menos un producto antes de confirmar la venta.',
            confirmButtonColor: '#f39c12'
        });
        return;
    }

    const data = {
        metodo_pago: this.metodo_pago.value,
        sucursal: this.sucursal.value,
        productos: productosAgregados
    };

    Swal.fire({
        title: 'Procesando venta...',
        text: 'Por favor espere un momento.',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    fetch("{% url 'crear_venta' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(data)
    })
    .then(res => {
        if (!res.ok) throw new Error("Error al registrar la venta");
        return res.json();
    })
    .then(() => {
        Swal.fire({
            icon: 'success',
            title: '¬°Venta completada!',
            text: 'La venta se registr√≥ exitosamente.',
            showConfirmButton: false,
            timer: 2000,
            backdrop: `
                rgba(0,0,0,0.6)
                url("https://cdn.dribbble.com/users/1187836/screenshots/6539429/check02.gif")
                center top
                no-repeat
            `
        }).then(() => {
            window.location.href = "{% url 'historial_ventas' %}";
        });
    })
    .catch(err => {
        Swal.fire({
            icon: 'error',
            title: 'Error al registrar venta',
            text: err.message,
            confirmButtonColor: '#d33'
        });
    });
});

/* Buscar con Enter */
document.getElementById("codigo_barras").addEventListener("keypress", e => {
    if (e.key === "Enter") {
        e.preventDefault();
        buscarProducto();
    }
});
</script>

{% endblock %}
